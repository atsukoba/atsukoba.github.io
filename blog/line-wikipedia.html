<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/><meta name="format-detection" content="telephone=no,address=no,email=no"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="google-site-verification" content="cI4es2OEvugGtOnNFAZf8XS1notJSgqSMmUlprSqjaM"/><title>Wikipediaから検索するLINE botを作った</title><meta name="robots" content="index,follow"/><meta name="description" content="`flask`, `line-bot-sdk` と `wikipedia`で作って，`heroku`にデプロイします。"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@atsuyakoba"/><meta property="og:title" content="Wikipediaから検索するLINE botを作った"/><meta property="og:description" content="`flask`, `line-bot-sdk` と `wikipedia`で作って，`heroku`にデプロイします。"/><meta property="og:url" content="https://www.atsuya.xyz/blog/line-wikipedia"/><meta property="og:image" content="https://www.atsuya.xyz/images/https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c"/><meta property="og:image:alt" content="Og Image Alt"/><meta property="og:image:width" content="800"/><meta property="og:image:height" content="600"/><meta property="og:image" content="https://www.atsuya.xyz/images/https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c"/><meta property="og:image:alt" content="Og Image Alt Second"/><meta property="og:image:width" content="900"/><meta property="og:image:height" content="800"/><meta property="og:image" content="https://www.atsuya.xyz/images/https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c"/><meta property="og:image" content="https://www.atsuya.xyz/images/https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c"/><meta property="og:site_name" content="atsuya.xyz"/><meta name="next-head-count" content="25"/><link rel="preload" href="/_next/static/css/bcc1205fa6e0070d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bcc1205fa6e0070d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-291ba6ccb9b61525.js" defer=""></script><script src="/_next/static/chunks/framework-73b8966a3c579ab0.js" defer=""></script><script src="/_next/static/chunks/main-2ead9bac7c570024.js" defer=""></script><script src="/_next/static/chunks/pages/_app-37511c91c7753360.js" defer=""></script><script src="/_next/static/chunks/674-056bceee6590161b.js" defer=""></script><script src="/_next/static/chunks/453-5401af4765a99201.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-c11e0e5aef6b77aa.js" defer=""></script><script src="/_next/static/KH92F5ynPqJdwJS_Xpogc/_buildManifest.js" defer=""></script><script src="/_next/static/KH92F5ynPqJdwJS_Xpogc/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header><div class="container"><a href="/" class="logo"><h1>atsuya koba</h1><span>v0.0.1</span></a><nav class=""><a href="/" class="logo nav-logo"><h1>atsuya koba</h1><span>v0.0.1</span></a><ul><li><a href="/blog">Blog</a></li><li><a href="/about">About Me</a></li><li><a href="https://twitter.com/atsuyakoba" target="_blank" rel="nofollow" class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li><li><a href="https://facebook.com/atsuyakoba" target="_blank" rel="nofollow" class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg></a></li><li><a href="https://www.linkedin.com/in/atsuyakobayashi" target="_blank" rel="nofollow" class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li><a href="https://github.com/atsukoba" target="_blank" rel="nofollow" class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a href="https://soundcloud.com/atsuyakoba" target="_blank" rel="nofollow" class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="soundcloud" class="svg-inline--fa fa-soundcloud " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M111.4 256.3l5.8 65-5.8 68.3c-.3 2.5-2.2 4.4-4.4 4.4s-4.2-1.9-4.2-4.4l-5.6-68.3 5.6-65c0-2.2 1.9-4.2 4.2-4.2 2.2 0 4.1 2 4.4 4.2zm21.4-45.6c-2.8 0-4.7 2.2-5 5l-5 105.6 5 68.3c.3 2.8 2.2 5 5 5 2.5 0 4.7-2.2 4.7-5l5.8-68.3-5.8-105.6c0-2.8-2.2-5-4.7-5zm25.5-24.1c-3.1 0-5.3 2.2-5.6 5.3l-4.4 130 4.4 67.8c.3 3.1 2.5 5.3 5.6 5.3 2.8 0 5.3-2.2 5.3-5.3l5.3-67.8-5.3-130c0-3.1-2.5-5.3-5.3-5.3zM7.2 283.2c-1.4 0-2.2 1.1-2.5 2.5L0 321.3l4.7 35c.3 1.4 1.1 2.5 2.5 2.5s2.2-1.1 2.5-2.5l5.6-35-5.6-35.6c-.3-1.4-1.1-2.5-2.5-2.5zm23.6-21.9c-1.4 0-2.5 1.1-2.5 2.5l-6.4 57.5 6.4 56.1c0 1.7 1.1 2.8 2.5 2.8s2.5-1.1 2.8-2.5l7.2-56.4-7.2-57.5c-.3-1.4-1.4-2.5-2.8-2.5zm25.3-11.4c-1.7 0-3.1 1.4-3.3 3.3L47 321.3l5.8 65.8c.3 1.7 1.7 3.1 3.3 3.1 1.7 0 3.1-1.4 3.1-3.1l6.9-65.8-6.9-68.1c0-1.9-1.4-3.3-3.1-3.3zm25.3-2.2c-1.9 0-3.6 1.4-3.6 3.6l-5.8 70 5.8 67.8c0 2.2 1.7 3.6 3.6 3.6s3.6-1.4 3.9-3.6l6.4-67.8-6.4-70c-.3-2.2-2-3.6-3.9-3.6zm241.4-110.9c-1.1-.8-2.8-1.4-4.2-1.4-2.2 0-4.2.8-5.6 1.9-1.9 1.7-3.1 4.2-3.3 6.7v.8l-3.3 176.7 1.7 32.5 1.7 31.7c.3 4.7 4.2 8.6 8.9 8.6s8.6-3.9 8.6-8.6l3.9-64.2-3.9-177.5c-.4-3-2-5.8-4.5-7.2zm-26.7 15.3c-1.4-.8-2.8-1.4-4.4-1.4s-3.1.6-4.4 1.4c-2.2 1.4-3.6 3.9-3.6 6.7l-.3 1.7-2.8 160.8s0 .3 3.1 65.6v.3c0 1.7.6 3.3 1.7 4.7 1.7 1.9 3.9 3.1 6.4 3.1 2.2 0 4.2-1.1 5.6-2.5 1.7-1.4 2.5-3.3 2.5-5.6l.3-6.7 3.1-58.6-3.3-162.8c-.3-2.8-1.7-5.3-3.9-6.7zm-111.4 22.5c-3.1 0-5.8 2.8-5.8 6.1l-4.4 140.6 4.4 67.2c.3 3.3 2.8 5.8 5.8 5.8 3.3 0 5.8-2.5 6.1-5.8l5-67.2-5-140.6c-.2-3.3-2.7-6.1-6.1-6.1zm376.7 62.8c-10.8 0-21.1 2.2-30.6 6.1-6.4-70.8-65.8-126.4-138.3-126.4-17.8 0-35 3.3-50.3 9.4-6.1 2.2-7.8 4.4-7.8 9.2v249.7c0 5 3.9 8.6 8.6 9.2h218.3c43.3 0 78.6-35 78.6-78.3.1-43.6-35.2-78.9-78.5-78.9zm-296.7-60.3c-4.2 0-7.5 3.3-7.8 7.8l-3.3 136.7 3.3 65.6c.3 4.2 3.6 7.5 7.8 7.5 4.2 0 7.5-3.3 7.5-7.5l3.9-65.6-3.9-136.7c-.3-4.5-3.3-7.8-7.5-7.8zm-53.6-7.8c-3.3 0-6.4 3.1-6.4 6.7l-3.9 145.3 3.9 66.9c.3 3.6 3.1 6.4 6.4 6.4 3.6 0 6.4-2.8 6.7-6.4l4.4-66.9-4.4-145.3c-.3-3.6-3.1-6.7-6.7-6.7zm26.7 3.4c-3.9 0-6.9 3.1-6.9 6.9L227 321.3l3.9 66.4c.3 3.9 3.1 6.9 6.9 6.9s6.9-3.1 6.9-6.9l4.2-66.4-4.2-141.7c0-3.9-3-6.9-6.9-6.9z"></path></svg></a></li></ul></nav></div></header><button id="menuButton" class=""><span></span><span></span><span></span></button><div style="width:100vw;padding-top:75px"></div><div class="container"><article class="article"><div class="breadcrumb"><span><span>/</span><a href="/blog">blog</a></span><span><span>/</span><a href="/blog/line-wikipedia">Wikipediaから検索するLINE botを作った</a></span></div><div class="key-visual" style="background-image:url(https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c)"></div><div class="article__info"><span class="article__category">Tech Blog</span><span class="article__date">2019 - 5 - 4</span></div><h1 class="article__title">Wikipediaから検索するLINE botを作った</h1><div class="article__tags"><a href="/blog/?tag=Python"><span class="card__post__tag">Python</span></a><a href="/blog/?tag=%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E3%83%9C%E3%83%83%E3%83%88"><span class="card__post__tag">チャットボット</span></a></div><p class="article__description">`flask`, `line-bot-sdk` と `wikipedia`で作って，`heroku`にデプロイします。</p><hr/><div class="article__contents"><p><code>flask</code>, <code>line-bot-sdk</code> と <code>wikipedia</code>で作って，<code>heroku</code>にデプロイします。</p>
<p><a href="http://nav.cx/9xRAMW8">ぜひ使って下さい。</a><a href="http://nav.cx/9xRAMW8" style="width:120px;height:35px;display:inline-block;border-radius:10px;background-image:url(https://scdn.line-apps.com/n/line_add_friends/btn/ja.png);background-size:cover">
</a></p>
<h2>完成図</h2>
<p><img src="https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c" alt="screenshot"/></p>
<p>レポジトリは<a href="https://github.com/atsukoba/Wikipedia-LINEbot">こちら</a></p>
<hr/>
<h2>準備</h2>
<p><code>pip install -r requirements.txt</code>させたいので，上記３つを requirements.txt へ記述し，heroku の設定と LINE@の設定を終わらせておく (アクセストークンとチャンネルシークレットあたりを入手しておく)。<code>runtime.txt</code>と<code>procfile</code>を置く。基本<a href="https://qiita.com/akabei/items/38f974716f194afea4a5">Heroku で LINE BOT(python)を動かしてみた</a>を真似た。</p>
<hr/>
<h2>Wikipedia について</h2>
<p>みんなだいすき Wikipedia。</p>
<pre><code class="language-bash">pip instal wikipedia
</code></pre>
<p>で入るライブラリである<a href="https://pypi.org/project/wikipedia/">Wikipedia</a>は非常に便利で，Python 用の<a href="https://ja.wikipedia.org/w/api.php">Media Wiki API</a>のラッパーだと解釈している。<code>requests</code>で API 叩いて，<code>BeautifulSoup4</code>か何かでマークアップをバラして，返してくれるものだったはず。</p>
<pre><code class="language-python">import wikipedia

wikipedia.set_lang(&quot;ja&quot;)
</code></pre>
<p>で日本語 Wikipedia に設定した後，</p>
<pre><code class="language-python">wikipedia.search(&quot;文字列&quot;)
</code></pre>
<p>をすることで各<code>ページ名</code>のリストが返り，書く Wikipedia のページはその名前(タイトル)が ID となっており，</p>
<pre><code class="language-python">wikipedia.page(&quot;ページ名&quot;)
</code></pre>
<p>で<code>wikipedia.WikipediaPage</code>オブジェクトを取得できる。この page オブジェクトが<code>categories</code>, <code>links</code>, <code>content</code>, <code>summary</code>などの attributes をもっており，これらは基本的に URL か文字列かのリストである。</p>
<pre><code class="language-python">&gt;&gt;&gt; help(wikipedia.WikipediaPage)
&gt;&gt;&gt;
&quot;&quot;&quot;
categories
    List of categories of a page.
content
    Plain text content of the page, excluding images, tables, and other data.
coordinates
    Tuple of Decimals in the form of (lat, lon) or None
images
    List of URLs of images on the page.
links
    List of titles of Wikipedia page links on a page.
    Only includes articles from namespace 0, meaning no Category, User talk, or other meta-Wikipedia pages.
parent_id
    Revision ID of the parent version of the current revision of this
    page. See ``revision_id`` for more information.
references
    List of URLs of external links on a page.
    May include external links within page that aren&#x27;t technically cited anywhere.
revision_id
    Revision ID of the page.
    The revision ID is a number that uniquely identifies the current
&quot;&quot;&quot;
</code></pre>
<p>今回つくる LINE Bot では，検索単語に対して取得した候補の中から 1 ページ選び，そのページの summary (タイトル直後の概要・OGP とかに表示される?)とページへのリンクを LINE トークルームにかえしてあげよう，というものを作ることにした。</p>
<hr/>
<h2>ファイルとか</h2>
<pre><code>.
├── Procfile
├── README.md
├── __pycache__
│   ├── app.cpython-36.pyc
│   └── parser.cpython-36.pyc
├── app.py
├── assets
│   └── img
│       └── linebot-icon.png
├── messenger.py
├── parser.py
├── requirements.txt
├── runtime.txt
└── test.py
</code></pre>
<hr/>
<h2><code>app.py</code></h2>
<p>次に，<code>flask</code>ベースでアプリケーション部分をササっと書きますが，これもほぼコピペ。面倒な部分を<code>linebot</code>が隠してくれていて，非常に便利。</p>
<pre><code class="language-python">from flask import Flask, request, abort

from linebot import (
    LineBotApi, WebhookHandler
)
from linebot.exceptions import (
    InvalidSignatureError
)
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
)

import parser
import os

app = Flask(__name__)

YOUR_CHANNEL_ACCESS_TOKEN = os.environ.get(&quot;YOUR_CHANNEL_ACCESS_TOKEN&quot;)
YOUR_CHANNEL_SECRET = os.environ.get(&quot;YOUR_CHANNEL_SECRET&quot;)

line_bot_api = LineBotApi(YOUR_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(YOUR_CHANNEL_SECRET)


@app.route(&quot;/callback&quot;, methods=[&#x27;POST&#x27;])
def callback():
    # get X-Line-Signature header value
    signature = request.headers[&#x27;X-Line-Signature&#x27;]

    # get request body as text
    body = request.get_data(as_text=True)
    app.logger.info(&quot;Request body: &quot; + body)

    # handle webhook body
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        print(&quot;Invalid signature. Please check your channel access token/channel secret.&quot;)
        abort(400)

    return &#x27;OK&#x27;


@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=parser.answer(event.message.text)))


if __name__ == &quot;__main__&quot;:
    port = int(os.getenv(&quot;PORT&quot;, 5000))
    app.run(host=&quot;0.0.0.0&quot;, port=port)
</code></pre>
<p>line-bot-sdk-python の公式リポジトリに，<code>app.py</code>として flask でのサンプルが公開されている。
<a href="https://github.com/line/line-bot-sdk-python/blob/master/examples/flask-echo/app.py">[sample] app.py</a></p>
<p>また，今回はそもそも README にガッツリ載っていたものを使った。<a href="https://github.com/line/line-bot-sdk-python/blob/master/README.rst">sample code on GitHub</a></p>
<hr/>
<h3><code>parser.py</code></h3>
<p>parser はモジュールの変数として言語設定を持っている。設計として微妙ですかね？モジュール(グローバル)変数は。<br/>
なんか使い方間違えたりとか，ヘルプ出したい時のための<code>usage()</code>は未実装。<br/>
意外と<code>WikipediaPage.summary</code>の文字数が長く，Messaging API の上限を叩いてしまったときのために，1500 文字以上は切っている。</p>
<pre><code class="language-python">import wikipedia


# init language setting
lang = &quot;ja&quot;
wikipedia.set_lang(lang)

def init() -&gt; None:
    global lang
    wikipedia.set_lang(lang)


def tokenize(text: str) -&gt; list:
    &quot;&quot;&quot;Tokenize input Sentence to list of word&quot;&quot;&quot;
    splited = text.split()
    if len(splited) == 1:
        return splited
    elif len(splited) == 2:
        if splited[0] in wikipedia.languages.fn().keys():
            change_lang(splited[0])
        return splited[1]
    else:
        usage()

def search(text: str, rank=0) -&gt; &quot;wikipedia.wikipedia.WikipediaPage&quot;:
    &quot;&quot;&quot;Search Wikipedia page by Word
    arg
    ---
    rank : int : Return the contents of the search result of the set rank.
    &quot;&quot;&quot;
    try:
        page = wikipedia.page(wikipedia.search(text)[rank])
    except wikipedia.exceptions.DisambiguationError:
        page = wikipedia.page(wikipedia.search(text)[rank+1])
    return page


def encode(page: &quot;wikipedia.wikipedia.WikipediaPage&quot;, threshold=1500) -&gt; str:
    &quot;&quot;&quot;Transform data into the text for LINE message
    &quot;&quot;&quot;
    summary = page.summary
    if len(summary) &gt; threshold:
        summary = summary[:threshold] + &quot;...&quot;

    return f&quot;Result: {page.title}\n\n{summary}\n\n{page.url}&quot;


def answer(text: str) -&gt; str:
    init()
    word = tokenize(text)
    page = search(word)
    return encode(page)


def change_lang(language: str) -&gt; None:
    wikipedia.set_lang(language)
    return

def usage():
    pass

if __name__ == &quot;__main__&quot;:
    import argparse

    parser = argparse.ArgumentParser()
    parser.parse_args()
</code></pre>
<p>一応ちゃんと<strong>PEP8</strong>スタイルだし，type hints も docstring 書いている。クセにしとおきたい。</p>
<hr/>
<h3>デプロイ等</h3>
<pre><code class="language-bash">$ heroku login
$ heroku create heroku-line-bot
$ heroku config:set LINE_CHANNEL_SECRET=&quot;&lt;Channel Secret&gt;&quot;
$ heroku config:set LINE_CHANNEL_ACCESS_TOKEN=&quot;&lt;アクセストークン&gt;&quot;
$ git push heroku master
</code></pre>
<hr/>
<h3>references</h3>
<ul>
<li><a href="https://github.com/line/line-bot-sdk-python">LINE Messaging API SDK for Python - GitHub</a></li>
<li><a href="https://qiita.com/kro/items/67f7510b36945eb9689b">Python で Line bot を作ってみた - Qiita</a></li>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/line-bot-sdk/">Messaging API SDK - LINE Developers</a></li>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/building-sample-bot-with-heroku/">Heroku でサンプルボットを作成する - LINE Developers</a></li>
<li><a href="https://qiita.com/msrks/items/c57e0168fb89f160d488">heroku に Flask アプリをデプロイする - Qiita</a></li>
</ul></div></article><a id="lineShareButton" href="https://social-plugins.line.me/lineit/share?url=Wikipedia%E3%81%8B%E3%82%89%E6%A4%9C%E7%B4%A2%E3%81%99%E3%82%8BLINE%20bot%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F%20-%20atsuya.xyz%0A%0Ahttps%3A%2F%2Fwww.atsuya.xyz%2Fblog%2Fline-wikipedia" target="_blank" data-size="large"><img src="/images/icon-line.png" alt=""/></a><a id="twitterShareButton" href="https://twitter.com/intent/tweet?text=Wikipedia%E3%81%8B%E3%82%89%E6%A4%9C%E7%B4%A2%E3%81%99%E3%82%8BLINE%20bot%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F%20-%20atsuya.xyz%0A%0Ahttps%3A%2F%2Fwww.atsuya.xyz%2Fblog%2Fline-wikipedia" rel="nofollow" data-size="large"><img src="/images/icon-twitter.png" alt=""/></a></div><footer><hr/><p>Atsuya Kobayashi 2018-2021</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"content":"\n`flask`, `line-bot-sdk` と `wikipedia`で作って，`heroku`にデプロイします。\n\n\u003ca href=\"http://nav.cx/9xRAMW8\" \u003eぜひ使って下さい。\u003c/a\u003e\u003ca href=\"http://nav.cx/9xRAMW8\" style=\"width: 120px;height: 35px;display: inline-block;border-radius: 10px;background-image: url(https://scdn.line-apps.com/n/line_add_friends/btn/ja.png);background-size: cover;\"\u003e\n\u003c/a\u003e\n\n\n## 完成図\n\n![screenshot](https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c)\n\nレポジトリは[こちら](https://github.com/atsukoba/Wikipedia-LINEbot)\n\n---\n\n## 準備\n\n`pip install -r requirements.txt`させたいので，上記３つを requirements.txt へ記述し，heroku の設定と LINE@の設定を終わらせておく (アクセストークンとチャンネルシークレットあたりを入手しておく)。`runtime.txt`と`procfile`を置く。基本[Heroku で LINE BOT(python)を動かしてみた](https://qiita.com/akabei/items/38f974716f194afea4a5)を真似た。\n\n---\n\n## Wikipedia について\n\nみんなだいすき Wikipedia。\n\n```bash\npip instal wikipedia\n```\n\nで入るライブラリである[Wikipedia](https://pypi.org/project/wikipedia/)は非常に便利で，Python 用の[Media Wiki API](https://ja.wikipedia.org/w/api.php)のラッパーだと解釈している。`requests`で API 叩いて，`BeautifulSoup4`か何かでマークアップをバラして，返してくれるものだったはず。\n\n```python\nimport wikipedia\n\nwikipedia.set_lang(\"ja\")\n```\n\nで日本語 Wikipedia に設定した後，\n\n```python\nwikipedia.search(\"文字列\")\n```\n\nをすることで各`ページ名`のリストが返り，書く Wikipedia のページはその名前(タイトル)が ID となっており，\n\n```python\nwikipedia.page(\"ページ名\")\n```\n\nで`wikipedia.WikipediaPage`オブジェクトを取得できる。この page オブジェクトが`categories`, `links`, `content`, `summary`などの attributes をもっており，これらは基本的に URL か文字列かのリストである。\n\n```python\n\u003e\u003e\u003e help(wikipedia.WikipediaPage)\n\u003e\u003e\u003e\n\"\"\"\ncategories\n    List of categories of a page.\ncontent\n    Plain text content of the page, excluding images, tables, and other data.\ncoordinates\n    Tuple of Decimals in the form of (lat, lon) or None\nimages\n    List of URLs of images on the page.\nlinks\n    List of titles of Wikipedia page links on a page.\n    Only includes articles from namespace 0, meaning no Category, User talk, or other meta-Wikipedia pages.\nparent_id\n    Revision ID of the parent version of the current revision of this\n    page. See ``revision_id`` for more information.\nreferences\n    List of URLs of external links on a page.\n    May include external links within page that aren't technically cited anywhere.\nrevision_id\n    Revision ID of the page.\n    The revision ID is a number that uniquely identifies the current\n\"\"\"\n```\n\n今回つくる LINE Bot では，検索単語に対して取得した候補の中から 1 ページ選び，そのページの summary (タイトル直後の概要・OGP とかに表示される?)とページへのリンクを LINE トークルームにかえしてあげよう，というものを作ることにした。\n\n---\n\n## ファイルとか\n\n```\n.\n├── Procfile\n├── README.md\n├── __pycache__\n│   ├── app.cpython-36.pyc\n│   └── parser.cpython-36.pyc\n├── app.py\n├── assets\n│   └── img\n│       └── linebot-icon.png\n├── messenger.py\n├── parser.py\n├── requirements.txt\n├── runtime.txt\n└── test.py\n```\n\n---\n\n## `app.py`\n\n次に，`flask`ベースでアプリケーション部分をササっと書きますが，これもほぼコピペ。面倒な部分を`linebot`が隠してくれていて，非常に便利。\n\n```python\nfrom flask import Flask, request, abort\n\nfrom linebot import (\n    LineBotApi, WebhookHandler\n)\nfrom linebot.exceptions import (\n    InvalidSignatureError\n)\nfrom linebot.models import (\n    MessageEvent, TextMessage, TextSendMessage,\n)\n\nimport parser\nimport os\n\napp = Flask(__name__)\n\nYOUR_CHANNEL_ACCESS_TOKEN = os.environ.get(\"YOUR_CHANNEL_ACCESS_TOKEN\")\nYOUR_CHANNEL_SECRET = os.environ.get(\"YOUR_CHANNEL_SECRET\")\n\nline_bot_api = LineBotApi(YOUR_CHANNEL_ACCESS_TOKEN)\nhandler = WebhookHandler(YOUR_CHANNEL_SECRET)\n\n\n@app.route(\"/callback\", methods=['POST'])\ndef callback():\n    # get X-Line-Signature header value\n    signature = request.headers['X-Line-Signature']\n\n    # get request body as text\n    body = request.get_data(as_text=True)\n    app.logger.info(\"Request body: \" + body)\n\n    # handle webhook body\n    try:\n        handler.handle(body, signature)\n    except InvalidSignatureError:\n        print(\"Invalid signature. Please check your channel access token/channel secret.\")\n        abort(400)\n\n    return 'OK'\n\n\n@handler.add(MessageEvent, message=TextMessage)\ndef handle_message(event):\n    line_bot_api.reply_message(\n        event.reply_token,\n        TextSendMessage(text=parser.answer(event.message.text)))\n\n\nif __name__ == \"__main__\":\n    port = int(os.getenv(\"PORT\", 5000))\n    app.run(host=\"0.0.0.0\", port=port)\n```\n\nline-bot-sdk-python の公式リポジトリに，`app.py`として flask でのサンプルが公開されている。\n[[sample] app.py](https://github.com/line/line-bot-sdk-python/blob/master/examples/flask-echo/app.py)\n\nまた，今回はそもそも README にガッツリ載っていたものを使った。[sample code on GitHub](https://github.com/line/line-bot-sdk-python/blob/master/README.rst)\n\n---\n\n### `parser.py`\n\nparser はモジュールの変数として言語設定を持っている。設計として微妙ですかね？モジュール(グローバル)変数は。  \nなんか使い方間違えたりとか，ヘルプ出したい時のための`usage()`は未実装。  \n意外と`WikipediaPage.summary`の文字数が長く，Messaging API の上限を叩いてしまったときのために，1500 文字以上は切っている。\n\n```python\nimport wikipedia\n\n\n# init language setting\nlang = \"ja\"\nwikipedia.set_lang(lang)\n\ndef init() -\u003e None:\n    global lang\n    wikipedia.set_lang(lang)\n\n\ndef tokenize(text: str) -\u003e list:\n    \"\"\"Tokenize input Sentence to list of word\"\"\"\n    splited = text.split()\n    if len(splited) == 1:\n        return splited\n    elif len(splited) == 2:\n        if splited[0] in wikipedia.languages.fn().keys():\n            change_lang(splited[0])\n        return splited[1]\n    else:\n        usage()\n\ndef search(text: str, rank=0) -\u003e \"wikipedia.wikipedia.WikipediaPage\":\n    \"\"\"Search Wikipedia page by Word\n    arg\n    ---\n    rank : int : Return the contents of the search result of the set rank.\n    \"\"\"\n    try:\n        page = wikipedia.page(wikipedia.search(text)[rank])\n    except wikipedia.exceptions.DisambiguationError:\n        page = wikipedia.page(wikipedia.search(text)[rank+1])\n    return page\n\n\ndef encode(page: \"wikipedia.wikipedia.WikipediaPage\", threshold=1500) -\u003e str:\n    \"\"\"Transform data into the text for LINE message\n    \"\"\"\n    summary = page.summary\n    if len(summary) \u003e threshold:\n        summary = summary[:threshold] + \"...\"\n\n    return f\"Result: {page.title}\\n\\n{summary}\\n\\n{page.url}\"\n\n\ndef answer(text: str) -\u003e str:\n    init()\n    word = tokenize(text)\n    page = search(word)\n    return encode(page)\n\n\ndef change_lang(language: str) -\u003e None:\n    wikipedia.set_lang(language)\n    return\n\ndef usage():\n    pass\n\nif __name__ == \"__main__\":\n    import argparse\n\n    parser = argparse.ArgumentParser()\n    parser.parse_args()\n```\n\n一応ちゃんと**PEP8**スタイルだし，type hints も docstring 書いている。クセにしとおきたい。\n\n---\n\n### デプロイ等\n\n```bash\n$ heroku login\n$ heroku create heroku-line-bot\n$ heroku config:set LINE_CHANNEL_SECRET=\"\u003cChannel Secret\u003e\"\n$ heroku config:set LINE_CHANNEL_ACCESS_TOKEN=\"\u003cアクセストークン\u003e\"\n$ git push heroku master\n```\n\n---\n\n### references\n\n- [LINE Messaging API SDK for Python - GitHub](https://github.com/line/line-bot-sdk-python)\n- [Python で Line bot を作ってみた - Qiita](https://qiita.com/kro/items/67f7510b36945eb9689b)\n- [Messaging API SDK - LINE Developers](https://developers.line.biz/ja/docs/messaging-api/line-bot-sdk/)\n- [Heroku でサンプルボットを作成する - LINE Developers](https://developers.line.biz/ja/docs/messaging-api/building-sample-bot-with-heroku/)\n- [heroku に Flask アプリをデプロイする - Qiita](https://qiita.com/msrks/items/c57e0168fb89f160d488)\n","data":{"title":"Wikipediaから検索するLINE botを作った","description":"`flask`, `line-bot-sdk` と `wikipedia`で作って，`heroku`にデプロイします。","slug":"line-wikipedia","date":"2019-05-04T00:26:20.000Z","category":"Tech Blog","tags":["Python","チャットボット"],"keyVisual":"https://repository-images.githubusercontent.com/184452650/ee9d3b80-6cab-11e9-9261-01e61f18fa3c"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"line-wikipedia"},"buildId":"KH92F5ynPqJdwJS_Xpogc","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>